# Cline Rules for Learning Odyssey

## Core Concepts

### Naming Conventions
1. Chapter: Unit of progression in ChapterType enum (LESSON, STORY, REFLECT, or CONCLUSION)
   - LESSON: Educational content from `lessons.csv` with LLM narrative wrapper using Story Object Method
   - STORY: Fully LLM-generated narrative content with choices, first chapter includes agency choice
   - REFLECT: Follow-up to LESSON chapters with narrative-driven approach to test deeper understanding
   - CONCLUSION: Final chapter with no choices, providing story resolution
2. State: Complete application state in `AdventureState` class
3. Adventure: Overall user journey tracked in `AdventureState`
4. Agency: User's first chapter choice that evolves throughout the adventure

### File Organization (`app/`)
1. Core application code:
   - State management: `models/story.py`
   - LLM integration: `services/llm/`
   - WebSocket components:
     * Routing: `routers/websocket_router.py`
     * Business logic: `services/websocket_service.py`
   - Chapter management: `services/chapter_manager.py`
   - Image generation: `services/image_generation_service.py`
2. Content sources:
   - Lesson database: `data/lessons.csv`
   - Story data: `data/stories/*.yaml` (individual files for each story category)
   - Story loader: `data/story_loader.py`
3. Frontend components:
   - HTML: `templates/index.html`
   - CSS: `static/css/` (modular organization)
     * `carousel.css`: 3D carousel styles
     * `choice-cards.css`: Choice button styles
     * `font-controls.css`: Font size adjustment controls
     * `header-controls.css`: Chapter indicator and controls
     * `loader.css`: Loading spinner styles
     * `theme.css`: Color scheme and theme variables
     * `typography.css`: Text styling and formatting
   - JavaScript: `static/js/`
     * `carousel-manager.js`: Reusable carousel component
     * `font-size-manager.js`: Text size adjustment for mobile
4. Tests: `tests/` directory
   - Story simulations: `tests/simulations/story_simulation.py`
   - Data tests: `tests/data/` (story loader, elements, chapter manager)

### Critical Implementation Rules
1. State Management:
   - `AdventureState` MUST be single source of truth
   - NEVER hardcode chapter numbers (app logic may change)
   - Use `planned_chapter_types` for chapter progression
   - Implement logic on state properties, not assumptions
   - Complete state serialization required
   - Dynamic story length via `state.story_length` (between 5 and 10 chapters)
   - Type hints required for all state properties
   - State changes must be logged
   - Agency choice MUST be stored in `state.metadata["agency"]`

2. Chapter Requirements:
   - First chapter MUST be STORY type with agency choice
   - Second-to-last chapter MUST be STORY type (for pivotal choices)
   - Last chapter MUST be CONCLUSION type (for story resolution)
   - 50% of remaining chapters, rounded down, MUST be LESSON type (subject to available questions)
   - 50% of LESSON chapters, rounded down, MUST be followed by REFLECT chapters
   - REFLECT chapters MUST only occur immediately after a LESSON chapter
   - STORY chapters MUST follow REFLECT chapters
   - No consecutive LESSON chapters allowed (highest priority)
   - At least 1 REFLECT chapter in every scenario (required)
   - No question repetition in session
   - Answer options MUST be shuffled
   - Immediate feedback required
   - Error recovery for failed state updates

3. Agency Implementation:
   - First chapter MUST include agency choice from four categories
   - Agency MUST be referenced in all subsequent chapters
   - Agency MUST evolve in REFLECT chapters based on answers
   - Agency MUST play pivotal role in climax phase
   - Agency MUST have meaningful resolution in conclusion
   - Agency references MUST be tracked with `update_agency_references()`

4. Image Generation:
   - Use `GOOGLE_API_KEY` environment variable
   - Implement 5 retries with exponential backoff
   - Add robust null checking for API responses
   - Handle failed generation gracefully
   - Use asynchronous processing to maintain performance
   - Image prompt structure MUST follow this format:
     ```
     Fantasy illustration of [Agency Name] in [Story Name], [Visual Details], with [adventure_state.selected_sensory_details["visuals"]], [Base Style]
     ```
   - Extract agency name with visual details up to the closing bracket
   - Include story name from `state.metadata["non_random_elements"]["name"]`
   - Omit redundant descriptions that come after the dash

5. Data Model:
   - Story categories in `new_stories.yaml` MUST include `settings` (renamed from `setting_types`)
   - `story_rules` field has been removed from the data model
   - Required narrative elements are now only `settings` (validator updated in `story.py`)
   - System prompt template uses `settings` but no longer includes `story_rules`

6. File Encoding:
   - All YAML files in `app/data/stories/` MUST be opened with UTF-8 encoding
   - Use `encoding="utf-8"` parameter when opening files in `story_loader.py`
   - This ensures proper handling of special characters in story content
   - Default Windows encoding (cp1252) cannot handle certain special characters

7. Frontend Component Architecture:
   - Use modular JavaScript classes for UI components
   - Implement the Carousel class with these requirements:
     * Constructor must accept configuration options (elementId, itemCount, dataAttribute, inputId, onSelect)
     * Support keyboard, button, and touch controls
     * Implement proper event handling and cleanup
     * Use mobile-specific optimizations when needed
   - Follow CSS organization pattern:
     * Component-specific CSS in dedicated files
     * Shared styles in theme.css and typography.css
     * Mobile-specific styles with media queries
   - Maintain progressive enhancement:
     * Core functionality must work without JavaScript
     * Add enhanced features when JavaScript is available
     * Provide fallbacks for older browsers

## Documentation

- Type hints are required for all functions.
- Docstrings are mandatory for all classes and functions.
- State changes must be logged.
- Agency references must be tracked.
